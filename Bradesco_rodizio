{
  "name": "Automa√ß√£o Bradesco P3 ü§ñ - Distribui√ß√£o e Rod√≠zio",
  "nodes": [
    {
      "parameters": {},
      "id": "trigger-p3",
      "name": "‚ö° Receber Lead Qualificado P2",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "position": [480, 340],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// SISTEMA DE ROD√çZIO COMPLETO COM VALIDA√á√ïES E OWNER √öNICO\nconst dados = $input.all()[0].json;\nconst sd = $getWorkflowStaticData('global');\n\n// CONFIGURA√á√ÉO COMPLETA DOS VENDEDORES - ROD√çZIO 1-5\nconst vendedores = [\n  {\n    nome: 'Fabiana',\n    email: 'comercial@abmix.com.br',\n    whatsapp: '+5511971593900',\n    agendor: '638d91d6-d527-4ab4-bbb4-8739b30b2d15',\n    sheet_id: '19_5eBzI4Isek9ib_Tdsy_CzUj421IR7IReiHG2s77kA',\n    sheet_url: 'https://docs.google.com/spreadsheets/d/19_5eBzI4Isek9ib_Tdsy_CzUj421IR7IReiHG2s77kA/edit?usp=sharing',\n    ativo: true\n  },\n  {\n    nome: 'Juliana',\n    email: 'comercial6@abmix.com.br',\n    whatsapp: '+5511938020607',\n    agendor: 'f9d3388b-2842-4011-8031-21effa4f787b',\n    sheet_id: '1I739og8MjuggQ_rJhrcyeDNGpkgzxLQ4Qim73Xy6MbU',\n    sheet_url: 'https://docs.google.com/spreadsheets/d/1I739og8MjuggQ_rJhrcyeDNGpkgzxLQ4Qim73Xy6MbU/edit?usp=sharing',\n    ativo: true\n  },\n  {\n    nome: 'Monique',\n    email: 'comercial2@abmix.com.br',\n    whatsapp: '+5511945352603',\n    agendor: '8b8b5a47-6626-4db2-99b6-6b769c3742c5',\n    sheet_id: '1rj7mWV6IkVrjVkAr0vFGW7IxtvPKF2JI6vZ42Uh8rcs',\n    sheet_url: 'https://docs.google.com/spreadsheets/d/1rj7mWV6IkVrjVkAr0vFGW7IxtvPKF2JI6vZ42Uh8rcs/edit?usp=sharing',\n    ativo: true\n  },\n  {\n    nome: 'Isabela',\n    email: 'comercial4@abmix.com.br',\n    whatsapp: '+5511953281647',\n    agendor: '6dd660a9-d4c1-436a-8528-b82e93157865',\n    sheet_id: '1qpkW3YtDlTKD7XzDn3NaT2dTCDWAWWr7q6Wku5ufAq4',\n    sheet_url: 'https://docs.google.com/spreadsheets/d/1qpkW3YtDlTKD7XzDn3NaT2dTCDWAWWr7q6Wku5ufAq4/edit?usp=sharing',\n    ativo: true\n  },\n  {\n    nome: 'Rodrigo',\n    email: 'supervisao@abmix.com.br',\n    whatsapp: '+5511996163900',\n    agendor: '6f1f347a-4599-4148-84c7-a54dad6384d8',\n    sheet_id: '1bUg8Kqhl_4dhIy_unfqqBYqhV9ICrGyHu3muv0LW1Hk',\n    sheet_url: 'https://docs.google.com/spreadsheets/d/1bUg8Kqhl_4dhIy_unfqqBYqhV9ICrGyHu3muv0LW1Hk/edit?gid=0#gid=0',\n    ativo: true\n  }\n];\n\n// SUPERVISOR (mesmo Rodrigo das configs acima)\nconst supervisor = vendedores.find(v => v.nome === 'Rodrigo');\n\n// FILTRA APENAS VENDEDORES ATIVOS\nconst vendedoresAtivos = vendedores.filter(v => v.ativo);\nif (vendedoresAtivos.length === 0) {\n  throw new Error('Nenhum vendedor ativo no sistema!');\n}\n\n// ROD√çZIO INTELIGENTE 1-5 COM TOLER√ÇNCIA A FALHAS\nsd.rodizio_idx = (sd.rodizio_idx === undefined ? -1 : sd.rodizio_idx);\nlet owner = null;\nlet tentativas = 0;\nconst maxTentativas = vendedoresAtivos.length;\n\n// BUSCAR VENDEDOR V√ÅLIDO - PULA PROBLEMAS AUTOMATICAMENTE\nwhile (!owner && tentativas < maxTentativas) {\n  sd.rodizio_idx = (sd.rodizio_idx + 1) % vendedoresAtivos.length;\n  const candidato = vendedoresAtivos[sd.rodizio_idx];\n  tentativas++;\n  \n  try {\n    // VALIDAR CREDENCIAIS DO CANDIDATO\n    ['email','whatsapp','agendor','sheet_url'].forEach(k=>{\n      if(!candidato[k]) throw new Error(`Credencial faltando: ${k}`);\n    });\n    \n    // CANDIDATO V√ÅLIDO - USAR COMO OWNER\n    owner = candidato;\n    console.log(`‚úÖ VENDEDOR SELECIONADO: ${owner.nome} (tentativa ${tentativas}/${maxTentativas})`);\n    \n  } catch (error) {\n    console.log(`‚ö†Ô∏è VENDEDOR PULADO: ${candidato.nome} - ${error.message}`);\n    // CONTINUA O LOOP PARA PR√ìXIMO VENDEDOR\n  }\n}\n\n// FALLBACK DE EMERG√äNCIA - SE TODOS FALHARAM\nif (!owner) {\n  console.log('üö® TODOS OS VENDEDORES COM PROBLEMA - USANDO FALLBACK');\n  owner = {\n    nome: 'SISTEMA-FALLBACK',\n    email: 'contato@abmixcorretora.com.br',\n    whatsapp: '+5511996163900',\n    agendor: '6f1f347a-4599-4148-84c7-a54dad6384d8',\n    sheet_url: 'https://docs.google.com/spreadsheets/d/1bUg8Kqhl_4dhIy_unfqqBYqhV9ICrGyHu3muv0LW1Hk/edit?gid=0#gid=0'\n  };\n}\n\nconst vendedor = owner; // manter compatibilidade\n\n// GERAR LEAD ID √öNICO\nconst leadId = dados.lead_id || 'BRAD-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5).toUpperCase();\n\n// CALCULAR SCORE SE N√ÉO EXISTIR\nlet score = dados.score || 0;\nif (!score) {\n  if (dados.total_vidas >= 30) score += 30;\n  else if (dados.total_vidas >= 10) score += 20;\n  else if (dados.total_vidas >= 3) score += 10;\n  \n  if (dados.idade_titular <= 45) score += 20;\n  else if (dados.idade_titular <= 55) score += 10;\n  \n  if (dados.tipo_contratacao === 'Com Coparticipa√ß√£o') score += 15;\n  \n  score = Math.min(score, 100);\n}\n\n// CLASSIFICAR LEAD\nlet classificacao = 'Frio';\nif (score >= 70) classificacao = 'Quente';\nelse if (score >= 40) classificacao = 'Morno';\n\n// CLASSIFICA√á√ÉO EMOJI\nlet classificacao_emoji = '‚ùÑÔ∏è Frio';\nif (score >= 70) classificacao_emoji = 'üî• Quente';\nelse if (score >= 40) classificacao_emoji = 'üôÇ Morno';\n\n// TELEFONE E164\nlet telefone_e164 = dados.telefone_e164;\nif (!telefone_e164) {\n  const d = String(dados.telefone || '').replace(/\\D/g,'');\n  telefone_e164 = d.startsWith('55') ? `+${d}` : `+55${d}`;\n}\n\n// SUGERIR PLANO\nlet plano_sugerido = 'Plano Efetivo';\nif (dados.total_vidas >= 30) plano_sugerido = 'Plano Top Nacional';\nelse if (dados.total_vidas >= 10) plano_sugerido = 'Plano Ades√£o Flex';\n\n// FORMATAR MENSAGEM PERSONALIZADA PARA VENDEDOR\nconst mensagemVendedor = `üî• *LEAD ${classificacao_emoji} - SCORE ${score}/100* üî•\\n\\n` +\n  `üìã *ID:* ${leadId}\\n` +\n  `üë§ *Nome:* ${dados.nome}\\n` +\n  `üì± *Telefone:* ${telefone_e164}\\n` +\n  `üìß *Email:* ${dados.email || 'N√£o informado'}\\n` +\n  `üìç *Cidade/Estado:* ${dados.cidade_estado || 'N√£o informado'}\\n\\n` +\n  `üë• *Total de Vidas:* ${dados.total_vidas}\\n` +\n  `üéÇ *Idade Titular:* ${dados.idade_titular} anos\\n` +\n  `üìã *Tipo Contrata√ß√£o:* ${dados.tipo_contratacao}\\n` +\n  `üè• *Hospital Prefer√™ncia:* ${dados.hospital_preferencia || 'N√£o informado'}\\n` +\n  `üíº *Plano Atual:* ${dados.plano_atual || 'N√£o possui'}\\n\\n` +\n  `‚≠ê *CLASSIFICA√á√ÉO:* ${classificacao}\\n` +\n  `üí∞ *Valor Estimado:* R$ ${(dados.total_vidas * 350).toLocaleString('pt-BR')}\\n` +\n  `üìå *Plano Sugerido:* ${plano_sugerido}\\n\\n` +\n  `üí¨ *√öltima Mensagem da Mariana:*\\n${dados.mensagem_mariana || 'Lead qualificado via formul√°rio'}\\n\\n` +\n  `‚ö° *A√á√ÉO IMEDIATA NECESS√ÅRIA!*\\n` +\n  `Entre em contato em at√© 15 minutos para maior convers√£o!`;\n\n// C√ìPIA PARA SUPERVISOR\nconst supervisor_copia = {\n  nome: supervisor.nome,\n  email: supervisor.email,\n  whatsapp: supervisor.whatsapp\n};\n\n// TRAVA ANTI-MISTURA DE CANAIS\nconst _check = {\n  to_email: owner.email,\n  to_whatsapp: owner.whatsapp,\n  to_agendor: owner.agendor,\n  to_sheet: owner.sheet_url\n};\n\n// RETORNAR TODOS OS DADOS PROCESSADOS\nreturn [{\n  ...dados,\n  lead_id: leadId,\n  vendedor: vendedor, // manter compatibilidade\n  owner: owner, // NOVO: owner √∫nico para todos os canais\n  supervisor: supervisor,\n  supervisor_copia: supervisor_copia,\n  score: score,\n  classificacao: classificacao,\n  classificacao_emoji: classificacao_emoji,\n  telefone_e164: telefone_e164,\n  plano_sugerido: plano_sugerido,\n  mensagem_vendedor: mensagemVendedor,\n  data_distribuicao: new Date().toISOString(),\n  timestamp_br: new Date().toLocaleString('pt-BR', {timeZone: 'America/Sao_Paulo'}),\n  _check: _check // trava anti-mistura\n}];"
      },
      "id": "sistema-rodizio",
      "name": "üéØ Sistema Rod√≠zio Inteligente",
      "type": "n8n-nodes-base.code",
      "position": [700, 340],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "10jkc1GdqYdgEp2SBIYf6uYq8-kuMQTAn7yd01yfNWw",
          "mode": "id"
        },
        "sheetName": "Leads-Qualificados_Bradesco",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Lead_ID": "={{$json.lead_id}}",
            "Nome": "={{$json.nome}}",
            "Telefone": "={{$json.telefone}}",
            "Telefone_E164": "={{$json.telefone_e164}}",
            "Email": "={{$json.email || ''}}",
            "Cidade_Estado": "={{$json.cidade_estado || ''}}",
            "Idade_Titular": "={{$json.idade_titular}}",
            "Total_Vidas": "={{$json.total_vidas}}",
            "Idades_Dependentes": "={{$json.idades_dependentes || ''}}",
            "Contratacao": "={{$json.tipo_contratacao}}",
            "Hospital_Preferencia": "={{$json.hospital_preferencia || ''}}",
            "Plano_Atual": "={{$json.plano_atual || ''}}",
            "Preexistencia": "={{$json.preexistencia || 'N√£o'}}",
            "Doenca_Grave": "={{$json.doenca_grave || 'N√£o'}}",
            "Classificacao": "={{$json.classificacao}}",
            "Classificacao_Emoji": "={{$json.classificacao_emoji}}",
            "Score": "={{$json.score}}",
            "Plano_Sugerido": "={{$json.plano_sugerido}}",
            "Documentos": "={{$json.documentos || 'Pendente'}}",
            "Data_Qualificacao": "={{$json.timestamp_br}}",
            "Status": "Qualificado - Distribu√≠do",
            "Vendedor_Nome": "={{$json.owner.nome}}",
            "Vendedor_Email": "={{$json.owner.email}}",
            "Vendedor_WhatsApp": "={{$json.owner.whatsapp}}",
            "Observa√ß√µes_Mariana": "={{$json.mensagem_mariana || ''}}",
            "Ultima_Atividade": "",
            "Tentativas_Remarketing": "0",
            "Remarketing_Data": "",
            "Mensagem": "={{$json.mensagem_vendedor}}"
          }
        }
      },
      "id": "planilha-principal",
      "name": "üìä Planilha Principal Qualificados",
      "type": "n8n-nodes-base.googleSheets",
      "position": [920, 340],
      "typeVersion": 4
    },
    {
      "parameters": {
        "dataType": "string",
        "value": "={{$json.owner.nome}}",
        "rules": {
          "rules": [
            { "output": 0, "value2": "Fabiana", "condition": "equal" },
            { "output": 1, "value2": "Juliana", "condition": "equal" },
            { "output": 2, "value2": "Monique", "condition": "equal" },
            { "output": 3, "value2": "Isabela", "condition": "equal" },
            { "output": 4, "value2": "Rodrigo", "condition": "equal" }
          ]
        }
      },
      "id": "switch-vendedor-individual",
      "name": "üîÄ Switch Vendedor Individual",
      "type": "n8n-nodes-base.switch",
      "position": [1140, 340],
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": { "__rl": true, "value": "={{$json.owner.sheet_url}}", "mode": "url" },
        "sheetName": "Leads_Bradesco",
        "columns": { "mappingMode": "defineBelow", "value": {
          "Lead_ID": "={{$json.lead_id}}",
          "Nome": "={{$json.nome}}",
          "Telefone": "={{$json.telefone}}",
          "Telefone_E164": "={{$json.telefone_e164}}",
          "Email": "={{$json.email || ''}}",
          "Cidade_Estado": "={{$json.cidade_estado || ''}}",
          "Idade_Titular": "={{$json.idade_titular}}",
          "Total_Vidas": "={{$json.total_vidas}}",
          "Idades_Dependentes": "={{$json.idades_dependentes || ''}}",
          "Contratacao": "={{$json.tipo_contratacao}}",
          "Hospital_Preferencia": "={{$json.hospital_preferencia || ''}}",
          "Plano_Atual": "={{$json.plano_atual || ''}}",
          "Preexistencia": "={{$json.preexistencia || 'N√£o'}}",
          "Doenca_Grave": "={{$json.doenca_grave || 'N√£o'}}",
          "Classificacao": "={{$json.classificacao}}",
          "Classificacao_Emoji": "={{$json.classificacao_emoji}}",
          "Score": "={{$json.score}}",
          "Plano_Sugerido": "={{$json.plano_sugerido}}",
          "Documentos": "Pendente",
          "Data_Qualificacao": "={{$json.timestamp_br}}",
          "Status": "Qualificado - Distribu√≠do",
          "Vendedor_Nome": "={{$json.owner.nome}}",
          "Vendedor_Email": "={{$json.owner.email}}",
          "Vendedor_WhatsApp": "={{$json.owner.whatsapp}}",
          "Observa√ß√µes_Mariana": "={{$json.mensagem_mariana || ''}}"
        } }
      },
      "id": "planilha-fabiana",
      "name": "üìä Planilha Fabiana",
      "type": "n8n-nodes-base.googleSheets",
      "position": [1360, 140],
      "typeVersion": 4
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": { "__rl": true, "value": "={{$json.owner.sheet_url}}", "mode": "url" },
        "sheetName": "Leads_Bradesco",
        "columns": { "mappingMode": "defineBelow", "value": {
            "Lead_ID": "={{$json.lead_id}}",
            "Nome": "={{$json.nome}}",
          "Telefone": "={{$json.telefone}}",
          "Telefone_E164": "={{$json.telefone_e164}}",
          "Email": "={{$json.email || ''}}",
          "Cidade_Estado": "={{$json.cidade_estado || ''}}",
            "Idade_Titular": "={{$json.idade_titular}}",
            "Total_Vidas": "={{$json.total_vidas}}",
          "Idades_Dependentes": "={{$json.idades_dependentes || ''}}",
            "Contratacao": "={{$json.tipo_contratacao}}",
          "Hospital_Preferencia": "={{$json.hospital_preferencia || ''}}",
          "Plano_Atual": "={{$json.plano_atual || ''}}",
          "Preexistencia": "={{$json.preexistencia || 'N√£o'}}",
          "Doenca_Grave": "={{$json.doenca_grave || 'N√£o'}}",
            "Classificacao": "={{$json.classificacao}}",
          "Classificacao_Emoji": "={{$json.classificacao_emoji}}",
            "Score": "={{$json.score}}",
          "Plano_Sugerido": "={{$json.plano_sugerido}}",
          "Documentos": "Pendente",
          "Data_Qualificacao": "={{$json.timestamp_br}}",
          "Status": "Qualificado - Distribu√≠do",
            "Vendedor_Nome": "={{$json.owner.nome}}",
          "Vendedor_Email": "={{$json.owner.email}}",
          "Vendedor_WhatsApp": "={{$json.owner.whatsapp}}",
          "Observa√ß√µes_Mariana": "={{$json.mensagem_mariana || ''}}"
        } }
      },
      "id": "planilha-juliana",
      "name": "üìä Planilha Juliana",
      "type": "n8n-nodes-base.googleSheets",
      "position": [1360, 240],
      "typeVersion": 4
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": { "__rl": true, "value": "={{$json.owner.sheet_url}}", "mode": "url" },
        "sheetName": "Leads_Bradesco",
        "columns": { "mappingMode": "defineBelow", "value": {
          "Lead_ID": "={{$json.lead_id}}",
          "Nome": "={{$json.nome}}",
          "Telefone": "={{$json.telefone}}",
          "Telefone_E164": "={{$json.telefone_e164}}",
          "Email": "={{$json.email || ''}}",
          "Cidade_Estado": "={{$json.cidade_estado || ''}}",
          "Idade_Titular": "={{$json.idade_titular}}",
          "Total_Vidas": "={{$json.total_vidas}}",
          "Idades_Dependentes": "={{$json.idades_dependentes || ''}}",
          "Contratacao": "={{$json.tipo_contratacao}}",
          "Hospital_Preferencia": "={{$json.hospital_preferencia || ''}}",
          "Plano_Atual": "={{$json.plano_atual || ''}}",
          "Preexistencia": "={{$json.preexistencia || 'N√£o'}}",
          "Doenca_Grave": "={{$json.doenca_grave || 'N√£o'}}",
          "Classificacao": "={{$json.classificacao}}",
          "Classificacao_Emoji": "={{$json.classificacao_emoji}}",
          "Score": "={{$json.score}}",
          "Plano_Sugerido": "={{$json.plano_sugerido}}",
          "Documentos": "Pendente",
          "Data_Qualificacao": "={{$json.timestamp_br}}",
          "Status": "Qualificado - Distribu√≠do",
          "Vendedor_Nome": "={{$json.owner.nome}}",
          "Vendedor_Email": "={{$json.owner.email}}",
          "Vendedor_WhatsApp": "={{$json.owner.whatsapp}}",
          "Observa√ß√µes_Mariana": "={{$json.mensagem_mariana || ''}}"
        } }
      },
      "id": "planilha-monique",
      "name": "üìä Planilha Monique",
      "type": "n8n-nodes-base.googleSheets",
      "position": [1360, 340],
      "typeVersion": 4
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": { "__rl": true, "value": "={{$json.owner.sheet_url}}", "mode": "url" },
        "sheetName": "Leads_Bradesco",
        "columns": { "mappingMode": "defineBelow", "value": {
          "Lead_ID": "={{$json.lead_id}}",
          "Nome": "={{$json.nome}}",
          "Telefone": "={{$json.telefone}}",
          "Telefone_E164": "={{$json.telefone_e164}}",
          "Email": "={{$json.email || ''}}",
          "Cidade_Estado": "={{$json.cidade_estado || ''}}",
          "Idade_Titular": "={{$json.idade_titular}}",
          "Total_Vidas": "={{$json.total_vidas}}",
          "Idades_Dependentes": "={{$json.idades_dependentes || ''}}",
          "Contratacao": "={{$json.tipo_contratacao}}",
          "Hospital_Preferencia": "={{$json.hospital_preferencia || ''}}",
          "Plano_Atual": "={{$json.plano_atual || ''}}",
          "Preexistencia": "={{$json.preexistencia || 'N√£o'}}",
          "Doenca_Grave": "={{$json.doenca_grave || 'N√£o'}}",
          "Classificacao": "={{$json.classificacao}}",
          "Classificacao_Emoji": "={{$json.classificacao_emoji}}",
          "Score": "={{$json.score}}",
          "Plano_Sugerido": "={{$json.plano_sugerido}}",
          "Documentos": "Pendente",
          "Data_Qualificacao": "={{$json.timestamp_br}}",
          "Status": "Qualificado - Distribu√≠do",
          "Vendedor_Nome": "={{$json.owner.nome}}",
          "Vendedor_Email": "={{$json.owner.email}}",
          "Vendedor_WhatsApp": "={{$json.owner.whatsapp}}",
          "Observa√ß√µes_Mariana": "={{$json.mensagem_mariana || ''}}"
        } }
      },
      "id": "planilha-isabela",
      "name": "üìä Planilha Isabela",
      "type": "n8n-nodes-base.googleSheets",
      "position": [1360, 440],
      "typeVersion": 4
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/1bUg8Kqhl_4dhIy_unfqqBYqhV9ICrGyHu3muv0LW1Hk/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": "Leads_Bradesco",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Lead_ID": "={{$json.lead_id}}",
            "Nome": "={{$json.nome}}",
            "Telefone": "={{$json.telefone}}",
            "Telefone_E164": "={{$json.telefone_e164}}",
            "Email": "={{$json.email || ''}}",
            "Cidade_Estado": "={{$json.cidade_estado || ''}}",
            "Idade_Titular": "={{$json.idade_titular}}",
            "Total_Vidas": "={{$json.total_vidas}}",
            "Idades_Dependentes": "={{$json.idades_dependentes || ''}}",
            "Contratacao": "={{$json.tipo_contratacao}}",
            "Hospital_Preferencia": "={{$json.hospital_preferencia || ''}}",
            "Plano_Atual": "={{$json.plano_atual || ''}}",
            "Preexistencia": "={{$json.preexistencia || 'N√£o'}}",
            "Doenca_Grave": "={{$json.doenca_grave || 'N√£o'}}",
            "Classificacao": "={{$json.classificacao}}",
            "Classificacao_Emoji": "={{$json.classificacao_emoji}}",
            "Score": "={{$json.score}}",
            "Plano_Sugerido": "={{$json.plano_sugerido}}",
            "Documentos": "={{$json.documentos || 'Pendente'}}",
            "Data_Qualificacao": "={{$json.timestamp_br}}",
            "Status": "Qualificado - Distribu√≠do",
            "Vendedor_Nome": "={{$json.owner.nome}}",
            "Vendedor_Email": "={{$json.owner.email}}",
            "Vendedor_WhatsApp": "={{$json.owner.whatsapp}}",
            "Observa√ß√µes_Mariana": "={{$json.mensagem_mariana || ''}}"
          }
        }
      },
      "id": "planilha-rodrigo-vendedor",
      "name": "üìä Planilha Rodrigo (Vendedor)",
      "type": "n8n-nodes-base.googleSheets",
      "position": [1360, 540],
      "typeVersion": 4
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/1bUg8Kqhl_4dhIy_unfqqBYqhV9ICrGyHu3muv0LW1Hk/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": "Auditoria_Bradesco",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Lead_ID": "={{$json.lead_id}}",
            "Nome": "={{$json.nome}}",
            "Telefone": "={{$json.telefone}}",
            "Telefone_E164": "={{$json.telefone_e164}}",
            "Email": "={{$json.email || ''}}",
            "Cidade_Estado": "={{$json.cidade_estado || ''}}",
            "Idade_Titular": "={{$json.idade_titular}}",
            "Total_Vidas": "={{$json.total_vidas}}",
            "Idades_Dependentes": "={{$json.idades_dependentes || ''}}",
            "Contratacao": "={{$json.tipo_contratacao}}",
            "Hospital_Preferencia": "={{$json.hospital_preferencia || ''}}",
            "Plano_Atual": "={{$json.plano_atual || ''}}",
            "Preexistencia": "={{$json.preexistencia || 'N√£o'}}",
            "Doenca_Grave": "={{$json.doenca_grave || 'N√£o'}}",
            "Classificacao": "={{$json.classificacao}}",
            "Classificacao_Emoji": "={{$json.classificacao_emoji}}",
            "Score": "={{$json.score}}",
            "Plano_Sugerido": "={{$json.plano_sugerido}}",
            "Documentos": "={{$json.documentos || 'Pendente'}}",
            "Data_Qualificacao": "={{$json.timestamp_br}}",
            "Status": "Distribu√≠do para {{$json.owner.nome}}",
            "Vendedor_Nome": "={{$json.owner.nome}}",
            "Vendedor_Email": "={{$json.owner.email}}",
            "Vendedor_WhatsApp": "={{$json.owner.whatsapp}}",
            "Observa√ß√µes_Mariana": "={{$json.mensagem_mariana || ''}}"
          }
        }
      },
      "id": "planilha-auditoria",
      "name": "üìä Planilha Auditoria Rodrigo",
      "type": "n8n-nodes-base.googleSheets",
      "position": [1580, 340],
      "typeVersion": 4
    },
    {
      "parameters": {
        "fromEmail": "felipemanieri@abmix.tech",
        "toEmail": "={{$json.owner.email}}",
        "subject": "=üî• LEAD {{$json.classificacao_emoji}} [Score: {{$json.score}}] - {{$json.nome}} - A√á√ÉO IMEDIATA!",
        "message": "=<html><body style='font-family: Arial, sans-serif;'>\\n<div style='background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px 10px 0 0;'>\\n  <h1 style='color: white; margin: 0;'>üî• NOVO LEAD QUALIFICADO!</h1>\\n  <p style='color: white; font-size: 18px; margin: 5px 0;'>Score: {{$json.score}}/100 - Classifica√ß√£o: {{$json.classificacao_emoji}}</p>\\n</div>\\n\\n<div style='background: #f8f9fa; padding: 20px; border-left: 4px solid #28a745;'>\\n  <h2 style='color: #28a745; margin-top: 0;'>üìã IDENTIFICA√á√ÉO DO LEAD</h2>\\n  <p><strong>ID:</strong> {{$json.lead_id}}</p>\\n  <p><strong>Nome:</strong> {{$json.nome}}</p>\\n  <p><strong>Telefone:</strong> <a href='tel:{{$json.telefone_e164}}'>{{$json.telefone_e164}}</a></p>\\n  <p><strong>Email:</strong> {{$json.email || 'N√£o informado'}}</p>\\n  <p><strong>Cidade/Estado:</strong> {{$json.cidade_estado || 'N√£o informado'}}</p>\\n</div>\\n\\n<div style='background: #fff; padding: 20px; border-left: 4px solid #007bff;'>\\n  <h2 style='color: #007bff;'>üë• INFORMA√á√ïES DO PLANO</h2>\\n  <p><strong>Total de Vidas:</strong> {{$json.total_vidas}}</p>\\n  <p><strong>Idade Titular:</strong> {{$json.idade_titular}} anos</p>\\n  <p><strong>Tipo Contrata√ß√£o:</strong> {{$json.tipo_contratacao}}</p>\\n  <p><strong>Hospital Prefer√™ncia:</strong> {{$json.hospital_preferencia || 'N√£o informado'}}</p>\\n  <p><strong>Plano Atual:</strong> {{$json.plano_atual || 'N√£o possui'}}</p>\\n  <p><strong>Preexist√™ncia:</strong> {{$json.preexistencia || 'N√£o'}}</p>\\n  <p><strong>Doen√ßa Grave:</strong> {{$json.doenca_grave || 'N√£o'}}</p>\\n</div>\\n\\n<div style='background: #fff3cd; padding: 20px; border-left: 4px solid #ffc107;'>\\n  <h2 style='color: #856404;'>üí∞ AN√ÅLISE COMERCIAL</h2>\\n  <p><strong>Plano Sugerido:</strong> {{$json.plano_sugerido}}</p>\\n  <p><strong>Valor Estimado:</strong> <span style='font-size: 24px; color: #28a745; font-weight: bold;'>R$ {{($json.total_vidas * 350).toLocaleString('pt-BR')}}</span></p>\\n</div>\\n\\n<div style='background: #d1ecf1; padding: 20px; border-left: 4px solid #17a2b8;'>\\n  <h2 style='color: #0c5460;'>üí¨ √öLTIMA INTERA√á√ÉO COM MARIANA</h2>\\n  <p style='font-style: italic;'>{{$json.mensagem_mariana || 'Lead qualificado diretamente via formul√°rio'}}</p>\\n</div>\\n\\n<div style='background: #f8d7da; padding: 20px; border-radius: 0 0 10px 10px; text-align: center;'>\\n  <h2 style='color: #721c24; margin: 0;'>‚ö° A√á√ÉO NECESS√ÅRIA!</h2>\\n  <p style='font-size: 16px; color: #721c24; margin: 10px 0;'><strong>Entre em contato em at√© 15 minutos para m√°xima convers√£o!</strong></p>\\n  <a href='tel:{{$json.telefone_e164}}' style='display: inline-block; padding: 12px 30px; background: #28a745; color: white; text-decoration: none; border-radius: 5px; font-size: 18px; margin: 10px;'>üìû LIGAR AGORA</a>\\n  <a href='https://wa.me/{{$json.telefone_e164.replace(\"+\", \"\")}}' style='display: inline-block; padding: 12px 30px; background: #25d366; color: white; text-decoration: none; border-radius: 5px; font-size: 18px; margin: 10px;'>üí¨ WHATSAPP</a>\\n</div>\\n\\n<p style='text-align: center; color: #6c757d; margin-top: 20px; font-size: 12px;'>\\n  Lead distribu√≠do em {{$json.timestamp_br}} | Sistema de Automa√ß√£o Bradesco Sa√∫de\\n</p>\\n</body></html>",
        "options": {
          "continueOnFail": true
        }
      },
      "id": "email-vendedor",
      "name": "üìß Email Vendedor",
      "type": "n8n-nodes-base.gmail",
      "position": [1800, 240],
      "typeVersion": 2.1,
      "credentials": {
        "gmailOAuth2": {
          "id": "gmail-felipe",
          "name": "Gmail Felipe"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://automacao-abmix-evolution-api.2ckrtx.easypanel.host/message/sendText/Bradesco",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "number", "value": "={{$json.owner.whatsapp}}" },
            { "name": "text", "value": "={{$json.mensagem_vendedor}}" }
          ]
        },
        "headerParameters": {
          "parameters": [
            { "name": "apikey", "value": "={{$credentials.evolutionApi.token}}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        }
      },
      "id": "whatsapp-vendedor",
      "name": "üì± WhatsApp Vendedor",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1800, 340],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://automacao-abmix-evolution-api.2ckrtx.easypanel.host/message/sendText/Bradesco",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "number", "value": "={{$json.supervisor.whatsapp}}" },
            { "name": "text", "value": "=üì¨ C√≥pia: {{$json.nome}} ‚Üí {{$json.owner.nome}} ‚Ä¢ {{$json.classificacao_emoji}}/{{$json.score}} ‚Ä¢ {{$json.telefone_e164}}" }
          ]
        },
        "headerParameters": {
          "parameters": [
            { "name": "apikey", "value": "={{$credentials.evolutionApi.token}}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        }
      },
      "id": "whatsapp-rodrigo",
      "name": "üì± WhatsApp Rodrigo",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1800, 440],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{$json.score}}",
              "operation": "largerEqual",
              "value2": 70
            }
          ]
        }
      },
      "id": "if-score-alto",
      "name": "Score >= 70?",
      "type": "n8n-nodes-base.if",
      "position": [2020, 340],
      "typeVersion": 1
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://automacao-abmix-evolution-api.2ckrtx.easypanel.host/message/sendText/Bradesco",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "number", "value": "5511996163900" },
            { "name": "text", "value": "=üö® *ALERTA: LEAD PREMIUM!* üö®\\n\\n*Score:* {{$json.score}}/100\\n*Cliente:* {{$json.nome}}\\n*Vidas:* {{$json.total_vidas}}\\n*Valor:* R$ {{($json.total_vidas * 350).toLocaleString('pt-BR')}}\\n*Vendedor:* {{$json.owner.nome}}\\n\\nLead de alta prioridade distribu√≠do!" }
          ]
        },
        "headerParameters": {
          "parameters": [
            { "name": "apikey", "value": "={{$credentials.evolutionApi.token}}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        }
      },
      "id": "alerta-rodrigo-premium",
      "name": "üö® Alerta WhatsApp Rodrigo (Score Alto)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [2240, 240],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "fromEmail": "felipemanieri@abmix.tech",
        "toEmail": "contato@abmixcorretora.com.br",
        "cc": "={{$json.supervisor_copia.email}}",
        "subject": "=[CONTROLE] Lead {{$json.lead_id}} ‚Üí {{$json.owner.nome}} ‚Ä¢ {{$json.classificacao_emoji}}/{{$json.score}}",
        "message": "=<html><body><h2>üìä Lead Qualificado Distribu√≠do</h2><p><strong>Lead:</strong> {{$json.nome}} ({{$json.lead_id}})</p><p><strong>Score:</strong> {{$json.score}}/100 ({{$json.classificacao_emoji}})</p><p><strong>Owner:</strong> {{$json.owner.nome}}</p><p><strong>Telefone:</strong> {{$json.telefone_e164}}</p><p><strong>Total Vidas:</strong> {{$json.total_vidas}}</p><p><strong>Valor Estimado:</strong> R$ {{($json.total_vidas * 350).toLocaleString('pt-BR')}}</p><p><strong>Planilha do vendedor:</strong> <a href='{{$json.owner.sheet_url}}'>Acessar Planilha</a></p><p><strong>Verifica√ß√£o Anti-Mistura:</strong><br/>Email: {{$json._check.to_email}}<br/>WhatsApp: {{$json._check.to_whatsapp}}<br/>Agendor: {{$json._check.to_agendor}}<br/>Planilha: {{$json._check.to_sheet}}</p></body></html>"
      },
      "id": "email-controle-todos",
      "name": "üìß Email Controle (Todos os Scores)",
      "type": "n8n-nodes-base.gmail",
      "position": [2020, 440],
      "typeVersion": 2.1,
      "credentials": { "gmailOAuth2": { "id": "gmail-felipe", "name": "Gmail Felipe" } },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.agendor.com.br/v3/people",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"name\":\"{{$json.nome}}\",\"ownerUserId\":\"638d91d6-d527-4ab4-bbb4-8739b30b2d15\",\"emails\":[{\"address\":\"{{$json.email}}\"}],\"phones\":[{\"number\":\"{{$json.telefone_e164}}\"}],\"city\":\"{{$json.cidade}}\",\"state\":\"{{$json.estado}}\",\"customFields\":{\"lead_id\":\"{{$json.lead_id}}\",\"vendedor\":\"Fabiana\"}}",
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "Token 638d91d6-d527-4ab4-bbb4-8739b30b2d15" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "options": { "continueOnFail": true }
      },
      "id": "agendor-fabiana",
      "name": "üíº Agendor Fabiana",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1800, 40],
      "typeVersion": 4.1
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.agendor.com.br/v3/people",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"name\":\"{{$json.nome}}\",\"ownerUserId\":\"f9d3388b-2842-4011-8031-21effa4f787b\",\"emails\":[{\"address\":\"{{$json.email}}\"}],\"phones\":[{\"number\":\"{{$json.telefone_e164}}\"}],\"city\":\"{{$json.cidade}}\",\"state\":\"{{$json.estado}}\",\"customFields\":{\"lead_id\":\"{{$json.lead_id}}\",\"vendedor\":\"Juliana\"}}",
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "Token f9d3388b-2842-4011-8031-21effa4f787b" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "options": { "continueOnFail": true }
      },
      "id": "agendor-juliana",
      "name": "üíº Agendor Juliana",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1800, 120],
      "typeVersion": 4.1
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.agendor.com.br/v3/people",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"name\":\"{{$json.nome}}\",\"ownerUserId\":\"8b8b5a47-6626-4db2-99b6-6b769c3742c5\",\"emails\":[{\"address\":\"{{$json.email}}\"}],\"phones\":[{\"number\":\"{{$json.telefone_e164}}\"}],\"city\":\"{{$json.cidade}}\",\"state\":\"{{$json.estado}}\",\"customFields\":{\"lead_id\":\"{{$json.lead_id}}\",\"vendedor\":\"Monique\"}}",
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "Token 8b8b5a47-6626-4db2-99b6-6b769c3742c5" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "options": { "continueOnFail": true }
      },
      "id": "agendor-monique",
      "name": "üíº Agendor Monique",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1800, 200],
      "typeVersion": 4.1
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.agendor.com.br/v3/people",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"name\":\"{{$json.nome}}\",\"ownerUserId\":\"6dd660a9-d4c1-436a-8528-b82e93157865\",\"emails\":[{\"address\":\"{{$json.email}}\"}],\"phones\":[{\"number\":\"{{$json.telefone_e164}}\"}],\"city\":\"{{$json.cidade}}\",\"state\":\"{{$json.estado}}\",\"customFields\":{\"lead_id\":\"{{$json.lead_id}}\",\"vendedor\":\"Isabela\"}}",
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "Token 6dd660a9-d4c1-436a-8528-b82e93157865" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "options": { "continueOnFail": true }
      },
      "id": "agendor-isabela",
      "name": "üíº Agendor Isabela",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1800, 280],
      "typeVersion": 4.1
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.agendor.com.br/v3/people",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"name\":\"{{$json.nome}}\",\"ownerUserId\":\"6f1f347a-4599-4148-84c7-a54dad6384d8\",\"emails\":[{\"address\":\"{{$json.email}}\"}],\"phones\":[{\"number\":\"{{$json.telefone_e164}}\"}],\"city\":\"{{$json.cidade}}\",\"state\":\"{{$json.estado}}\",\"customFields\":{\"lead_id\":\"{{$json.lead_id}}\",\"vendedor\":\"Rodrigo\"}}",
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "Token 6f1f347a-4599-4148-84c7-a54dad6384d8" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "options": { "continueOnFail": true }
      },
      "id": "agendor-rodrigo",
      "name": "üíº Agendor Rodrigo",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1800, 360],
      "typeVersion": 4.1
    },
    {
      "parameters": {
        "jsCode": "// VALIDA√á√ÉO RESILIENTE - REGISTRA PROBLEMAS MAS CONTINUA FLUXO\nconst dados = $input.all()[0].json;\nlet alertas = [];\n\n// Verifica se o owner est√° presente\nif (!dados.owner || !dados.owner.email) {\n  alertas.push('‚ö†Ô∏è Owner ausente no contexto!');\n  console.log('üö® ERRO CR√çTICO: Owner ausente no contexto!');\n  // Continua mesmo com problema - fluxo n√£o pode parar\n}\n\n// Valida√ß√µes com logs de alerta (n√£o interrompe)\nif (dados.owner && dados._check) {\n  if (dados._check.to_email !== dados.owner.email) {\n    alertas.push(`Email: ${dados._check.to_email} != ${dados.owner.email}`);\n  }\n  \n  if (dados._check.to_whatsapp !== dados.owner.whatsapp) {\n    alertas.push(`WhatsApp: ${dados._check.to_whatsapp} != ${dados.owner.whatsapp}`);\n  }\n  \n  if (dados._check.to_agendor !== dados.owner.agendor) {\n    alertas.push(`Agendor: ${dados._check.to_agendor} != ${dados.owner.agendor}`);\n  }\n  \n  if (dados._check.to_sheet !== dados.owner.sheet_url) {\n    alertas.push(`Planilha: ${dados._check.to_sheet} != ${dados.owner.sheet_url}`);\n  }\n}\n\n// Logs de resultado\nif (alertas.length > 0) {\n  console.log(`‚ö†Ô∏è ALERTAS DETECTADOS (${alertas.length}):`);\n  alertas.forEach(alerta => console.log(`   - ${alerta}`));\n  console.log('üîÑ FLUXO CONTINUA MESMO COM ALERTAS');\n} else {\n  console.log(`‚úÖ VALIDA√á√ÉO OK - Owner: ${dados.owner?.nome || 'N/A'} | Lead: ${dados.lead_id}`);\n  console.log(`üìß Email: ${dados._check?.to_email || 'N/A'}`);\n  console.log(`üì± WhatsApp: ${dados._check?.to_whatsapp || 'N/A'}`);\n  console.log(`üíº Agendor: ${dados._check?.to_agendor || 'N/A'}`);\n  console.log(`üìä Planilha: ${dados._check?.to_sheet || 'N/A'}`);\n}\n\n// SEMPRE RETORNA DADOS - FLUXO NUNCA PARA\nreturn [{\n  ...dados,\n  alertas_validacao: alertas\n}];"
      },
      "id": "validacao-anti-mistura",
      "name": "üîí Valida√ß√£o Resiliente",
      "type": "n8n-nodes-base.code",
      "position": [1800, 140],
      "typeVersion": 2
    }
  ],
  "connections": {
    "‚ö° Receber Lead Qualificado P2": {
      "main": [[{"node": "üéØ Sistema Rod√≠zio Inteligente"}]]
    },
    "üéØ Sistema Rod√≠zio Inteligente": {
      "main": [[{"node": "üìä Planilha Principal Qualificados"}]]
    },
    "üìä Planilha Principal Qualificados": {
      "main": [[
        {"node": "üîÄ Switch Vendedor Individual"},
        {"node": "üìä Planilha Auditoria"},
        {"node": "üìß Email Controle (Todos os Scores)"}
      ]]
    },
    "üîÄ Switch Vendedor Individual": {
      "main": [
        [{"node": "üìä Planilha Fabiana"}],
        [{"node": "üìä Planilha Juliana"}],
        [{"node": "üìä Planilha Monique"}],
        [{"node": "üìä Planilha Isabela"}],
        [{"node": "üìä Planilha Rodrigo (Vendedor)"}]
      ]
    },
    "üìä Planilha Fabiana": {
      "main": [[
        {"node": "üíº Agendor Fabiana"},
        {"node": "üîí Valida√ß√£o Resiliente"}
      ]]
    },
    "üìä Planilha Juliana": {
      "main": [[
        {"node": "üíº Agendor Juliana"},
        {"node": "üîí Valida√ß√£o Resiliente"}
      ]]
    },
    "üìä Planilha Monique": {
      "main": [[
        {"node": "üíº Agendor Monique"},
        {"node": "üîí Valida√ß√£o Resiliente"}
      ]]
    },
    "üìä Planilha Isabela": {
      "main": [[
        {"node": "üíº Agendor Isabela"},
        {"node": "üîí Valida√ß√£o Resiliente"}
      ]]
    },
    "üìä Planilha Rodrigo (Vendedor)": {
      "main": [[
        {"node": "üíº Agendor Rodrigo"},
        {"node": "üîí Valida√ß√£o Resiliente"}
      ]]
    },
    "üíº Agendor Fabiana": {
      "main": [[]]
    },
    "üíº Agendor Juliana": {
      "main": [[]]
    },
    "üíº Agendor Monique": {
      "main": [[]]
    },
    "üíº Agendor Isabela": {
      "main": [[]]
    },
    "üíº Agendor Rodrigo": {
      "main": [[]]
    },
    "üîí Valida√ß√£o Resiliente": {
      "main": [[
        {"node": "üìß Email Vendedor"},
        {"node": "üì± WhatsApp Vendedor"},
        {"node": "üì± WhatsApp Rodrigo"},
        {"node": "Score >= 70?"}
      ]]
    },
    "Score >= 70?": {
      "main": [
        [{"node": "üö® Alerta WhatsApp Rodrigo (Score Alto)"}],
        []
      ]
    }
  }
}
